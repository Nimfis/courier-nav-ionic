<ion-header>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/routes"></ion-back-button>
    </ion-buttons>
    <ion-title>Punkt</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <ion-card *ngIf="waypoint as w">
    <ion-card-header>
      <ion-card-title>{{ w.order }}. {{ w.title }}</ion-card-title>
      <ion-card-subtitle>{{ w.description }}</ion-card-subtitle>
    </ion-card-header>

    <ion-card-content>
      <ion-item lines="none">
        <ion-label class="ion-text-wrap">
          <b>Promień zaliczenia:</b> {{ w.radiusMeters ?? 50 }} m
          <p *ngIf="distanceMeters !== undefined">
            <b>Twoja odległość:</b> {{ distanceMeters }} m
          </p>
        </ion-label>
      </ion-item>

      <ion-item lines="none" *ngIf="arrived">
        <ion-icon name="checkmark-circle" color="success" slot="start"></ion-icon>
        <ion-label>
          <b>Jesteś na miejscu</b>
          <p *ngIf="visitedAt">Odwiedzone: {{ asPolishDate(visitedAt) }}</p>
        </ion-label>
      </ion-item>

      <ion-item lines="none" *ngIf="!arrived">
        <ion-icon name="lock-closed" color="medium" slot="start"></ion-icon>
        <ion-label class="ion-text-wrap">
          <b>Materiały zablokowane</b>
          <p>Odblokują się, gdy znajdziesz się w promieniu punktu.</p>
        </ion-label>
      </ion-item>

      <ion-button expand="block" (click)="navigateToPoint()">
        NAWIGUJ
      </ion-button>

      <ion-button
        expand="block"
        color="primary"
        [disabled]="checkingLocation"
        (click)="checkArrival()"
      >
        {{ checkingLocation ? 'Sprawdzam lokalizację...' : 'Sprawdź czy jestem na miejscu' }}
      </ion-button>

      <ion-text color="danger" *ngIf="locationError">
        <p style="margin-top: 10px">{{ locationError }}</p>
      </ion-text>
    </ion-card-content>
  </ion-card>

  <ion-card *ngIf="loading">
    <ion-card-header>
      <ion-card-title>Ładowanie…</ion-card-title>
    </ion-card-header>
  </ion-card>

  <!-- Materiały: pokazuj dopiero po arrived -->
  <ion-list *ngIf="!loading && arrived">
    <ion-list-header>
      <ion-label>Materiały (odblokowane)</ion-label>
    </ion-list-header>

    <ion-item *ngIf="materials.length === 0" lines="none">
      <ion-label>Brak materiałów dla tego punktu.</ion-label>
    </ion-item>

    <ng-container *ngFor="let m of materials">
      <!-- TEXT -->
      <ion-item lines="none" *ngIf="m.type === 'text'">
        <ion-label class="ion-text-wrap">
          <h2>{{ m.title }}</h2>
          <p>{{ m.content }}</p>
        </ion-label>
      </ion-item>

      <!-- CODE -->
      <ion-item lines="none" *ngIf="m.type === 'code'">
        <ion-label class="ion-text-wrap">
          <h2>{{ m.title }}</h2>
          <ion-chip color="primary">
            <ion-label>{{ m.content }}</ion-label>
          </ion-chip>
        </ion-label>
      </ion-item>

      <!-- AUDIO -->
      <ion-item lines="none" *ngIf="m.type === 'audio'">
        <ion-label class="ion-text-wrap">
          <h2>{{ m.title }}</h2>
          <audio
            controls
            preload="none"
            style="width: 100%; margin-top: 8px"
            [src]="resolveUrl(m.url)"
          ></audio>
        </ion-label>
      </ion-item>

      <!-- VIDEO -->
      <ion-item lines="none" *ngIf="m.type === 'video'">
        <ion-label class="ion-text-wrap">
          <h2>{{ m.title || 'Wideo' }}</h2>

          <!-- YouTube w okienku -->
          <ng-container *ngIf="m.url && isYouTube(m.url)">
            <div style="position: relative; padding-top: 56.25%; width: 100%; margin-top: 8px;">
              <iframe
                [src]="toYouTubeEmbed(m.url)"
                style="position:absolute; inset:0; width:100%; height:100%; border:0;"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
              ></iframe>
            </div>
          </ng-container>

          <!-- Zwykłe MP4 / bezpośredni link -->
          <ng-container *ngIf="m.url && !isYouTube(m.url)">
            <video
              controls
              preload="metadata"
              playsinline
              style="width: 100%; margin-top: 8px"
              [src]="resolveUrl(m.url)"
            ></video>
          </ng-container>

          <ion-button
            *ngIf="m.url"
            size="small"
            fill="clear"
            class="ion-margin-top"
            (click)="openUrl(m.url)"
          >
            Otwórz link
          </ion-button>
        </ion-label>
      </ion-item>
    </ng-container>
  </ion-list>
</ion-content>
